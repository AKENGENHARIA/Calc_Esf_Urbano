<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Consulta de Projetos</title>
    <link rel="stylesheet" href="css/style_dashboard.css">

</head>

<body>
    <div class="sidebar">
        <button id="continuarBtn" disabled onclick="continuarProjeto()">Continuar</button>
        <button id="editarBtn" disabled onclick="abrirModal()">Editar</button>
        <button id="concluirBtn" disabled onclick="concluirProjeto()">Concluir</button>
        <button id="excluirBtn" disabled onclick="excluirProjeto()">Excluir</button>
        <button id="relatorioBtn" disabled onclick="salvarRelatorio()">Salvar Relatório</button>
    </div>

    <div class="container">
        <h1>Dashboard - Consulta de Projetos</h1>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Pesquisar por cidade, empresa ou concessionária">
            <button id="searchBtn">Pesquisar</button>
        </div>

        <div class="filter-status">
            <label for="statusFilter">Filtrar por status:</label>
            <select id="statusFilter">
                <option value="">Todos</option>
                <option value="em andamento">Em Andamento</option>
                <option value="finalizado">Finalizado</option>
            </select>
        </div>

        <div id="loading" class="loading">Carregando projetos...</div>

        <table id="projetosTable">
            <thead>
                <tr>
                    <th>Nome do Projeto</th>
                    <th>Cidade</th>
                    <th>Empresa</th>
                    <th>Concessionária</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pagination" id="pagination"></div>
        <div class="error-message" id="errorMessage"></div>
    </div>

    <!-- Modal para editar projeto -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" id="closeModal">&times;</span>
                <h2>Editar Projeto</h2>
            </div>
            <div class="modal-body">
                <label for="modalNome">Nome do Projeto</label>
                <input type="text" id="modalNome">

                <label for="modalCidade">Cidade</label>
                <input type="text" id="modalCidade">

                <label for="modalEmpresa">Empresa</label>
                <input type="text" id="modalEmpresa">

                <label for="modalConcessionaria">Concessionária</label>
                <input type="text" id="modalConcessionaria">

                <label for="modalStatus">Status</label>
                <select id="modalStatus">
                    <option value="em andamento">Em Andamento</option>
                    <option value="finalizado">Finalizado</option>
                </select>
            </div>
            <div class="modal-footer">
                <button id="saveBtn" onclick="salvarProjetoEditado()" disabled>Salvar</button>
            </div>
        </div>
    </div>

    <script>
        let projetoSelecionadoId = null;
        let projetoSelecionado = null; // Variável para armazenar os dados do projeto selecionado

        // Função para abrir o modal de edição
        function abrirModal() {
            if (projetoSelecionado) {
                document.getElementById('modalNome').value = projetoSelecionado.nome_projeto;
                document.getElementById('modalCidade').value = projetoSelecionado.cidade;
                document.getElementById('modalEmpresa').value = projetoSelecionado.empresa;
                document.getElementById('modalConcessionaria').value = projetoSelecionado.concessionaria;
                document.getElementById('modalStatus').value = projetoSelecionado.status;

                document.getElementById('editModal').style.display = 'block';
                verificarCamposModal(); // Verificar campos do modal ao abrir
            }
        }

        // Fechar modal ao clicar no "x"
        document.getElementById('closeModal').onclick = function () {
            document.getElementById('editModal').style.display = 'none';
        };

        // Fechar modal ao clicar fora dele
        window.onclick = function (event) {
            if (event.target === document.getElementById('editModal')) {
                document.getElementById('editModal').style.display = 'none';
            }
        };

        // Verificar se os campos do modal estão preenchidos
        function verificarCamposModal() {
            const nomeProjeto = document.getElementById('modalNome').value;
            const cidade = document.getElementById('modalCidade').value;
            const empresa = document.getElementById('modalEmpresa').value;
            const concessionaria = document.getElementById('modalConcessionaria').value;

            // Habilita o botão de salvar apenas se todos os campos estiverem preenchidos
            const botaoSalvar = document.getElementById('saveBtn');
            botaoSalvar.disabled = !nomeProjeto || !cidade || !empresa || !concessionaria;
        }

        // Função para salvar o projeto editado
 // Função para salvar o projeto editado
// Função para salvar o projeto editado
function salvarProjetoEditado() {
    const nome_projeto = document.getElementById('modalNome').value;
    const cidade = document.getElementById('modalCidade').value;
    const empresa = document.getElementById('modalEmpresa').value;
    const concessionaria = document.getElementById('modalConcessionaria').value;
    const status = document.getElementById('modalStatus').value;

    // Fazer a requisição para atualizar o projeto
    fetch(`http://localhost:3000/api/projetos/editar-projeto/${projetoSelecionadoId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome_projeto, cidade, empresa, concessionaria, status })  // Enviando os dados editados
    })
    .then(response => {
        console.log("Status da resposta:", response.status);  // Verificar o status da resposta
        console.log("Resposta completa:", response);  // Verificar a resposta completa

        if (!response.ok) {
            return response.json().then(errData => {
                throw new Error(errData.message || 'Erro desconhecido ao atualizar o projeto.');
            });
        }
        return response.json();  // Verificar o JSON da resposta
    })
    .then(data => {
        console.log("Dados da resposta JSON:", data);  // Verificar o conteúdo da resposta JSON
        // Se a atualização foi bem-sucedida
        if (data.success) {
            alert('Projeto atualizado com sucesso!');
            fetchProjects(); // Atualizar a lista de projetos após a edição
            document.getElementById('editModal').style.display = 'none';
        } else {
            alert('Erro ao atualizar o projeto.');
        }
    })
    .catch(error => {
        // Captura qualquer erro e exibe uma mensagem
        console.error('Erro ao salvar projeto:', error);
        alert(`Erro ao salvar projeto: ${error.message}`);
    });
}




        // Adicionar eventos para verificar campos do modal
        document.getElementById('modalNome').addEventListener('input', verificarCamposModal);
        document.getElementById('modalCidade').addEventListener('input', verificarCamposModal);
        document.getElementById('modalEmpresa').addEventListener('input', verificarCamposModal);
        document.getElementById('modalConcessionaria').addEventListener('input', verificarCamposModal);

        // Carregar projetos e habilitar seleção
        function fetchProjects(query = '', page = 1, status = '') {
            const loadingElement = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.innerHTML = '';

            if (loadingElement) loadingElement.style.display = 'block';

            fetch(`http://localhost:3000/api/projetos/consultar?search=${encodeURIComponent(query)}&status=${encodeURIComponent(status)}&page=${page}`)
                .then(response => {
                    if (loadingElement) loadingElement.style.display = 'none';
                    if (!response.ok) {
                        return response.json().then(errData => {
                            throw new Error(errData.message || 'Erro desconhecido ao buscar projetos.');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    const tableBody = document.querySelector('#projetosTable tbody');
                    tableBody.innerHTML = '';

                    if (data.projetos.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5">Nenhum projeto encontrado.</td></tr>';
                        return;
                    }

                    data.projetos.forEach(projeto => {
                        const row = document.createElement('tr');
                        row.dataset.id = projeto.id; // Adicionar ID como atributo data
                        row.innerHTML = `
                            <td>${projeto.nome_projeto}</td>
                            <td>${projeto.cidade}</td>
                            <td>${projeto.empresa}</td>
                            <td>${projeto.concessionaria}</td>
                            <td>${projeto.status}</td>
                        `;

                        row.onclick = function () {
                            selecionarProjeto(projeto);
                        };

                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    if (loadingElement) loadingElement.style.display = 'none';
                    console.error('Erro ao buscar projetos:', error);
                    errorMessage.innerHTML = `Erro: ${error.message}`;
                });

        }

        function selecionarProjeto(projeto) {
            projetoSelecionadoId = projeto.id;
            projetoSelecionado = projeto;

            // Remove a seleção anterior
            const rows = document.querySelectorAll('#projetosTable tr');
            rows.forEach(row => row.classList.remove('selected-row'));

            // Adiciona a seleção na linha clicada
            const selectedRow = document.querySelector(`tr[data-id="${projeto.id}"]`);
            selectedRow.classList.add('selected-row');

            // Habilita os botões
            document.getElementById('continuarBtn').disabled = false;
            document.getElementById('editarBtn').disabled = false;
            document.getElementById('concluirBtn').disabled = false;
            document.getElementById('excluirBtn').disabled = false;
            document.getElementById('relatorioBtn').disabled = false;
        }

        window.onload = function () {
            fetchProjects();
        };

        document.getElementById('searchBtn').addEventListener('click', function () {
            const query = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            fetchProjects(query, 1, status);
        });
    </script>
</body>

</html>