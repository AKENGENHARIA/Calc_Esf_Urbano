<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Calculadora de Esforço Urbano</title>
    <link rel="stylesheet" href="css/style_dashboard.css">
    <style>
        /* Estilos básicos para o carregamento e paginação */
        .loading {
            display: none;
            text-align: center;
            font-weight: bold;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .pagination button {
            padding: 5px 10px;
            margin: 0 5px;
            border: 1px solid #007BFF;
            background-color: white;
            cursor: pointer;
        }

        .pagination button.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .error-message {
            color: red;
            font-weight: bold;
            text-align: center;
        }

        .filter-status {
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <button id="continuarBtn" disabled onclick="continuarProjeto()">Continuar</button>
        <button id="editarBtn" disabled onclick="editarProjeto()">Editar</button>
        <button id="concluirBtn" disabled onclick="concluirProjeto()">Concluir</button>
        <button id="excluirBtn" disabled onclick="excluirProjeto()">Excluir</button>
        <button id="relatorioBtn" disabled onclick="salvarRelatorio()">Salvar Relatório</button>

    </div>

    <div class="container">
        <h1>Dashboard - Consulta de Projetos</h1>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Pesquisar por cidade, empresa ou concessionária">
            <button id="searchBtn">Pesquisar</button>
        </div>

        <div class="filter-status">
            <label for="statusFilter">Filtrar por status:</label>
            <select id="statusFilter">
                <option value="">Todos</option>
                <option value="em andamento">Em Andamento</option>
                <option value="finalizado">Finalizado</option>
            </select>
        </div>

        <!-- Indicador de carregamento -->
        <div id="loading" class="loading">Carregando projetos...</div>

        <table id="projetosTable">
            <thead>
                <tr>
                    <th>Nome do Projeto</th>
                    <th>Cidade</th>
                    <th>Empresa</th>
                    <th>Concessionária</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pagination" id="pagination"></div>
        <div class="error-message" id="errorMessage"></div>
    </div>

    <script>
        function fetchProjects(query = '', page = 1, status = '', sortColumn = '', sortDirection = 'asc') {
            const loadingElement = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.innerHTML = ''; // Limpar mensagem de erro
        
            // Verificar se o elemento #loading existe
            if (loadingElement) {
                loadingElement.style.display = 'block'; // Mostrar indicador de carregamento
            }
        
            fetch(`/consultar?search=${encodeURIComponent(query)}&page=${page}&status=${encodeURIComponent(status)}&sortColumn=${sortColumn}&sortDirection=${sortDirection}`, {
                method: 'GET'
            })
            .then(response => {
                if (loadingElement) {
                    loadingElement.style.display = 'none'; // Esconder indicador de carregamento
                }
                if (!response.ok) {
                    throw new Error('Erro ao buscar projetos. Status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const tableBody = document.querySelector('#projetosTable tbody');
                tableBody.innerHTML = ''; // Limpar tabela antes de preencher com novos dados
        
                if (data.projetos.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5">Nenhum projeto encontrado.</td></tr>';
                    return;
                }
        
                // Preenche a tabela com os dados retornados e adiciona o evento de clique
                data.projetos.forEach(projeto => {
                    console.log(projeto);  // Verifique se o campo "id" está sendo retornado corretamente
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${projeto.nome_projeto}</td>
                        <td>${projeto.cidade}</td>
                        <td>${projeto.empresa}</td>
                        <td>${projeto.concessionaria}</td>
                        <td>${projeto.status}</td>
                    `;
        
                    // Adicionar o evento de clique para selecionar a linha e associar o ID do projeto
                    row.onclick = function () {
                        console.log('ID do projeto:', projeto.id); // Log para verificar se o ID está correto
                        selecionarProjeto(projeto.id, this);  // Passa o campo correto "id"
                    };
        
                    tableBody.appendChild(row);
                });
        
                // Atualizar a paginação
                atualizarPaginacao(data.totalPages, page);
            })
            .catch(error => {
                if (loadingElement) {
                    loadingElement.style.display = 'none'; // Esconder indicador de carregamento em caso de erro
                }
                console.error('Erro ao consultar projetos:', error);
                errorMessage.innerHTML = 'Erro ao carregar projetos. Tente novamente mais tarde.';
            });
        }
        
        let projetoSelecionadoId = null; // Garantir que a variável de seleção de projeto está definida
        
        // Função para selecionar um projeto ao clicar na linha da tabela
        function selecionarProjeto(projetoId, linhaSelecionada) {
            console.log('Projeto selecionado:', projetoId);
        
            projetoSelecionadoId = projetoId;
        
            const rows = document.querySelectorAll('#projetosTable tr');
            rows.forEach(row => row.classList.remove('selected-row'));
        
            linhaSelecionada.classList.add('selected-row');
        
            // Habilita os botões de ação
            document.getElementById('continuarBtn').disabled = false;
            document.getElementById('editarBtn').disabled = false;
            document.getElementById('concluirBtn').disabled = false;
            document.getElementById('excluirBtn').disabled = false;
            document.getElementById('relatorioBtn').disabled = false;
        }
        
        // Função para atualizar a paginação
        function atualizarPaginacao(totalPages, currentPage) {
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = ''; // Limpar a paginação anterior
        
            // Criar botões para cada página
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('disabled', i === currentPage); // Desabilitar o botão da página atual
        
                pageButton.onclick = () => {
                    const query = document.getElementById('searchInput').value;
                    const status = document.getElementById('statusFilter').value;
                    fetchProjects(query, i, status); // Chama fetchProjects com a página selecionada
                };
        
                paginationElement.appendChild(pageButton);
            }
        }
        
        // Carregar todos os projetos ao carregar a página
        window.onload = function () {
            fetchProjects();
        };
        
        document.getElementById('searchBtn').addEventListener('click', function () {
            const query = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            fetchProjects(query, 1, status);
        });
        
        // Função para continuar o projeto
        function continuarProjeto() {
            if (projetoSelecionadoId) {
                window.location.href = `/producao?projetoId=${projetoSelecionadoId}`;
            } else {
                alert('Selecione um projeto para continuar.');
            }
        }
        
        // Função para editar o projeto
        function editarProjeto() {
            if (projetoSelecionadoId) {
                window.location.href = `/editar-projeto?projetoId=${projetoSelecionadoId}`;
            } else {
                alert('Selecione um projeto para editar.');
            }
        }
        
        // Função para concluir o projeto
        function concluirProjeto() {
            if (projetoSelecionadoId && confirm("Tem certeza de que deseja concluir este projeto?")) {
                fetch(`/concluir-projeto/${projetoSelecionadoId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Projeto concluído com sucesso!');
                            fetchProjects(); // Atualiza a lista de projetos
                        } else {
                            alert('Erro ao concluir o projeto.');
                        }
                    })
                    .catch(error => console.error('Erro:', error));
            }
        }
        
        // Função para excluir o projeto
        function excluirProjeto() {
            if (projetoSelecionadoId && confirm("Tem certeza de que deseja excluir este projeto?")) {
                fetch(`/excluir-projeto/${projetoSelecionadoId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Projeto excluído com sucesso!');
                            fetchProjects(); // Atualiza a lista de projetos
                        } else {
                            alert('Erro ao excluir o projeto.');
                        }
                    })
                    .catch(error => console.error('Erro:', error));
            }
        }
        
        // Função para salvar o relatório
        function salvarRelatorio() {
            if (projetoSelecionadoId) {
                fetch(`/gerar-relatorio/${projetoSelecionadoId}`, { method: 'GET' })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao gerar relatório. Status: ' + response.status);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `relatorio_projeto_${projetoSelecionadoId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url); // Limpar o link temporário
                    })
                    .catch(error => console.error('Erro ao salvar o relatório:', error));
            } else {
                alert('Selecione um projeto para gerar o relatório.');
            }
        }
    </script>
    
    
</body>

</html>