<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Esforço Urbano</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href='public/css/style_Poste.css'> <!-- Adicionando o CSS do Modal -->
    <script src="https://unpkg.com/pdf-lib@1.16.0/dist/pdf-lib.min.js"></script>

</head>


<body>

    <h1>Calculadora de Esforço Urbano</h1>

    <!-- Modal para Informações do Poste -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <h2>CARACTERÍSTICAS DO POSTE</h2>

            <div class="form-group">
                <label for="numeroPoste">Nº do Poste</label><br>
                <input type="text" id="numeroPoste">
            </div>

            <div class="form-row">
                <div class="radio-group">
                    <h4>Tipo</h4>
                    <label><input type="radio" name="tipoPoste" value="SC"> Poste SC</label>
                    <label><input type="radio" name="tipoPoste" value="Madeira"> Poste Madeira</label>
                    <label><input type="radio" name="tipoPoste" value="DT"> Poste DT</label>
                    <label><input type="radio" name="tipoPoste" value="Aço"> Poste AÇO</label>
                </div>

                <div class="radio-group">
                    <h4>Altura (m)</h4>
                    <label><input type="radio" name="altura" value="9"> 9</label>
                    <label><input type="radio" name="altura" value="10"> 10</label>
                    <label><input type="radio" name="altura" value="11"> 11</label>
                    <label><input type="radio" name="altura" value="12"> 12</label>
                    <label><input type="radio" name="altura" value="13"> 13</label>
                    <label><input type="radio" name="altura" value="15"> 15</label>
                    <label><input type="radio" name="altura" value="18"> 18</label>
                </div>

                <div class="radio-group">
                    <h4>Capacidade (daN)</h4>
                    <label><input type="radio" name="capacidade" value="100"> 100</label>
                    <label><input type="radio" name="capacidade" value="150"> 150</label>
                    <label><input type="radio" name="capacidade" value="200"> 200</label>
                    <label><input type="radio" name="capacidade" value="300"> 300</label>
                    <label><input type="radio" name="capacidade" value="400"> 400</label>
                    <label><input type="radio" name="capacidade" value="450"> 450</label>
                    <label><input type="radio" name="capacidade" value="600"> 600</label>
                    <label><input type="radio" name="capacidade" value="1000"> 1000</label>
                </div>
            </div>

            <button id="confirmar">CONFIRMAR</button>
        </div>
    </div>

    <div class="forces-container" id="forces-container">
        <!-- Força Layouts Gerados com Loop -->
    </div>

    <!-- Buttons -->
    <div id="buttons">
        <button class="button" id="Salvar">Salvar</button>
        <button class="button" id="calcular">calcular</button>
        <div id="resultado"></div>
    </div>

    <script>
        let ultimoPosteId = null; // Para armazenar o ID do poste criado
        let projetoId = getProjetoIdFromURL(); // Obtém o projeto ID

        // Função para obter o projetoId da URL
        function getProjetoIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('projetoId');
        }

        // Função para exibir o modal e buscar o último poste do projeto
        window.onload = function () {
            if (projetoId) {
                // Buscar o último poste do projeto
                fetch(`https://us-central1-akraquercem.cloudfunctions.net/api/projetos/${projetoId}/ultimo-poste`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Alerta com o número do último poste salvo
                            const ultimoPoste = data.numeroPoste;
                            alert(`O último poste salvo foi: ${ultimoPoste}. Continuando com o próximo...`);
                            document.getElementById("postModal").style.display = "block";
                        } else {
                            console.error('Erro ao buscar o último poste.');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar o último poste:', error);
                    });
            } else {
                alert('Projeto não selecionado.');
            }
        };

        // Capturar o ID do poste ao confirmar os dados do modal
        document.getElementById('confirmar').addEventListener('click', function () {
            const numeroPoste = parseInt(document.getElementById("numeroPoste").value);
            const tipoPoste = document.querySelector('input[name="tipoPoste"]:checked')?.value;
            const altura = document.querySelector('input[name="altura"]:checked')?.value;
            const capacidade = document.querySelector('input[name="capacidade"]:checked')?.value;

            if (numeroPoste && tipoPoste && altura && capacidade) {
                // Enviar os dados do poste para o backend e capturar o posteId
                fetch('https://us-central1-akraquercem.cloudfunctions.net/api/postes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        numeroPoste,
                        tipoPoste,
                        altura,
                        capacidade,
                        projetoId
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            ultimoPosteId = data.id; // Captura o ID do poste criado
                            document.getElementById("postModal").style.display = "none";
                            generateForceInputs(); // Gera os inputs para as forças após o modal ser fechado
                        } else {
                            alert('Erro ao salvar o poste.');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao salvar o poste:', error);
                    });
            } else {
                alert('Por favor, preencha todos os campos.');
            }
        });

        // Função para gerar os campos das forças
        function generateForceInputs() {
            const forceData = [
                { id: 'F1', estaioId: 1 },
                { id: 'F2', estaioId: 2 },
                { id: 'F3', estaioId: 3 },
                { id: 'F4', estaioId: 4 },
                { id: 'F5', estaioId: 5 }
            ];

            const forcesContainer = document.getElementById('forces-container');
            forcesContainer.innerHTML = ''; // Limpar os campos existentes

            forceData.forEach(force => {
                const forceHTML = `
                    <div class="force-input" id="${force.id}">
                        <h3>FORÇA ${force.estaioId}</h3>
                        <section class="vao-ang">
                            <label for="span${force.estaioId}_${force.id}">Vão:</label>
                            <input type="number" id="span${force.estaioId}_${force.id}" value="">
                            <label for="angle${force.estaioId}_${force.id}">Ângulo:</label>
                            <input type="number" id="angle${force.estaioId}_${force.id}" value="">
                        </section>
                        <!-- Adiciona o resto dos campos aqui -->
                    </div>
                `;
                forcesContainer.innerHTML += forceHTML;
            });
        }

        // Função para calcular a resultante e o ângulo
        function calcularResultante() {
            let xResultante = 0;
            let yResultante = 0;

            const forceData = [
                { id: 'F1', estaioId: 1 },
                { id: 'F2', estaioId: 2 },
                { id: 'F3', estaioId: 3 },
                { id: 'F4', estaioId: 4 },
                { id: 'F5', estaioId: 5 }
            ];

            // Percorre todas as forças e calcula as componentes de x e y
            forceData.forEach(force => {
                let angulo = parseFloat(document.getElementById(`angle${force.estaioId}_${force.id}`)?.value) || 0;
                let redeMt = parseFloat(document.getElementById(`rede_mt_${force.id}`)?.value) || 0;
                let redeBt = parseFloat(document.getElementById(`rede_bt_${force.id}`)?.value) || 0;
                let nivelMt = parseFloat(document.getElementById(`nivel_cruzeta_mt_${force.id}`)?.value) || 0;

                let somaF = (redeMt * nivelMt) + redeBt;
                let rad = angulo * Math.PI / 180;
                let x = somaF * Math.cos(rad);
                let y = somaF * Math.sin(rad);

                xResultante += x;
                yResultante += y;
            });

            // Calcula a magnitude e o ângulo do vetor resultante
            const magnitudeResultante = Math.sqrt(xResultante * xResultante + yResultante * yResultante);
            const anguloResultante = Math.atan2(yResultante, xResultante) * 180 / Math.PI;

            // Retorna os valores calculados
            return { resultante: magnitudeResultante.toFixed(2), anguloResultante: anguloResultante.toFixed(2) };
        }

        // Evento para calcular e exibir a resultante quando o botão é clicado
        document.getElementById('calcular').addEventListener('click', function () {
            const { resultante, anguloResultante } = calcularResultante();
            alert(`Vetor Resultante: ${resultante}, Ângulo: ${anguloResultante}°`);
        });

        // Função para salvar as forças
        document.getElementById('Salvar').addEventListener('click', () => {
            if (!verificarForcasPreenchidas()) {
                alert('Por favor, insira pelo menos uma força antes de salvar.');
                return;
            }

            const forceData = [
                { id: 'F1', estaioId: 1 },
                { id: 'F2', estaioId: 2 },
                { id: 'F3', estaioId: 3 },
                { id: 'F4', estaioId: 4 },
                { id: 'F5', estaioId: 5 }
            ];

            // Percorre cada força e envia os dados preenchidos
            forceData.forEach(force => {
                const vao = document.getElementById(`span${force.estaioId}_${force.id}`)?.value || null;
                const angulo = document.getElementById(`angle${force.estaioId}_${force.id}`)?.value || null;

                // Captura os IDs (como rede_mt, rede_bt) e valores correspondentes
                const redeMtId = document.getElementById(`rede_mt_${force.id}`)?.value || null;
                const redeBtId = document.getElementById(`rede_bt_${force.id}`)?.value || null;
                const nivelCruzeta = document.getElementById(`nivel_cruzeta_mt_${force.id}`)?.value || null;

                const estaioId = document.getElementById(`estaio_${force.estaioId}`)?.value || null;
                const usoMutuoId = document.getElementById(`usoMutuo_${force.id}`)?.value || null;

                // Verifica se ao menos o ID do poste está preenchido
                if (ultimoPosteId) {
                    fetch('https://us-central1-akraquercem.cloudfunctions.net/api/postes-forcas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            poste_id: ultimoPosteId,
                            vao,
                            angulo,
                            rede_mt: redeMtId,
                            rede_bt: redeBtId,
                            nivel_cruzeta_mt: nivelCruzeta,
                            estaio: estaioId,
                            uso_mutuo: usoMutuoId
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Força salva com sucesso!');
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao enviar os dados:', error);
                            alert('Erro ao salvar força.');
                        });
                } else {
                    alert('Erro ao salvar o poste. Poste ID não encontrado.');
                }
            });
        });

        // Função para verificar se pelo menos uma força foi preenchida
        function verificarForcasPreenchidas() {
            const forceInputs = document.querySelectorAll('.force-input input');
            return Array.from(forceInputs).some(input => input.value.trim() !== "");
        }
    </script>

</body>

</html>
